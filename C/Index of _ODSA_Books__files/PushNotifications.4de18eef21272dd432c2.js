(window.__LOADABLE_LOADED_CHUNKS__=window.__LOADABLE_LOADED_CHUNKS__||[]).push([["PushNotifications"],{"./src/graphql/operations/RegisterWebPushToken.json":function(e){e.exports=JSON.parse('{"id":"197650c1946c"}')},"./src/reddit/actions/notifications/index.ts":function(e,t,s){"use strict";s.r(t);s("./node_modules/core-js/modules/es6.regexp.to-string.js");var i=s("./src/config.ts"),n=s("./node_modules/lodash/omit.js"),o=s.n(n),r=s("./src/lib/browser/isIncognito.ts"),a=s("./src/lib/constants/index.ts"),c=s("./src/lib/localStorageAvailable/index.ts"),u=(s("./node_modules/core-js/modules/es6.regexp.replace.js"),e=>{const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(t),i=new Uint8Array(s.length);for(let n=0;n<s.length;++n)i[n]=s.charCodeAt(n);return i}),d=s("./src/reddit/actions/notifications/constants.ts"),l=s("./src/reddit/actions/notifications/state.ts"),g=s("./src/reddit/actions/notifications/utils.ts"),b=s("./src/reddit/actions/tabBadging.ts"),f=s("./src/reddit/actions/toaster.ts"),m=s("./src/graphql/operations/RegisterWebPushToken.json"),p=s("./src/lib/makeGqlRequest/index.ts"),j=s("./src/lib/timezone/index.ts");var v=s("./src/reddit/helpers/tabBadging/index.ts"),O=s("./src/reddit/helpers/trackers/notifications.ts"),h=s("./src/reddit/i18n/utils.ts"),_=s("./src/reddit/models/Toast/index.ts"),k=s("./src/reddit/selectors/experiments/badging.ts");s.d(t,"getBrowserNotificationPermission",(function(){return S})),s.d(t,"resetPermissionRequestClosed",(function(){return y})),s.d(t,"isBrowserSubscribedForPushNotifications",(function(){return N})),s.d(t,"initializeServiceWorkerChannel",(function(){return x})),s.d(t,"requestNotificationsPermissions",(function(){return q})),s.d(t,"subscribeForPNs",(function(){return I})),s.d(t,"unsubscribeFromPNs",(function(){return W}));const w=4*a.I,S=()=>{const e=Object(c.a)()&&"1"===localStorage.getItem("notification-permission-request-closed");return"granted"===Notification.permission?d.a.Granted:"denied"===Notification.permission?d.a.Denied:e?d.a.Closed:d.a.Default},y=()=>!!Object(c.a)()&&(localStorage.removeItem("notification-permission-request-closed"),!0),N=async()=>{let e;try{e=await navigator.serviceWorker.register("/sw.js")}catch(t){return!1}return null!==await e.pushManager.getSubscription()},P=e=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({command:"registerClient",v2EventBoilerPlate:O.b(e)})};let C=!1;const x=async(e,t)=>{const s=Object(k.a)(e);if(C)return;if(C=!0,Object(g.a)(e)!==d.f.NotificationsSupported)return;try{await navigator.serviceWorker.register("/sw.js")}catch(i){return}navigator.serviceWorker.addEventListener("message",i=>{const n=i.data,r=n.command;if("registerWithServiceWorker"===r)P(e);else if(r===v.a&&s){const e=o()(n,["command"]);t(Object(b.c)(e))}}),P(e)},q=(e,t)=>async(s,i,n)=>{const o=i();if(await Object(r.a)())return;if(await x(o,s),Object(c.a)()){const t=localStorage.getItem("push-token-last-refresh-ms"),s=(new Date).getTime();if(!e&&t&&parseInt(t)+w>s)return;localStorage.setItem("push-token-last-refresh-ms",s.toString())}O.i(o);const a=Object(g.a)(o);if(a===d.f.BrowserUnsupported)return;if(a===d.f.LocalStorageUnavailable)return;if(a===d.f.NotAllRequiredAPIsSupported)return;if("denied"===Notification.permission)return void s(Object(d.m)());if("granted"===Notification.permission)return s(Object(d.n)()),void s(I());const u=localStorage.getItem("notification-permission-request-closed");if(t||!u||"1"!==u)switch(s(Object(d.p)()),s(Object(d.o)()),O.g(o),await Notification.requestPermission()){case"granted":s(Object(d.n)()),s(I()),O.c(o);break;case"denied":s(Object(d.m)()),O.d(o);break;default:s(Object(d.m)()),O.e(o),localStorage.setItem("notification-permission-request-closed","1")}},I=e=>async(t,s,n)=>{const o=s();try{const r=await navigator.serviceWorker.register("/sw.js");let a=await r.pushManager.getSubscription();if(!a){const e={userVisibleOnly:!0,applicationServerKey:u(i.a.pushNotificationApplicationServerKey)};a=await r.pushManager.subscribe(e)}Object(l.c)();const c=await((e,t,s)=>{const i={pushToken:JSON.stringify(s),timezoneName:Object(j.b)()||j.a,timestamp:(new Date).toISOString(),language:"en_us"};return Object(p.a)(e,Object.assign({},m,{variables:i}))})(n.gqlContext(),s(),a),d=c.body.data.registerWebPushToken;c.ok?d&&!d.ok?O.h(o,"registration_failed_in_gql"):(O.j(o),e&&t(Object(f.e)({kind:_.b.SuccessCommunity,text:Object(h.c)("Changes saved")}))):O.h(o,"registration_failed_generally")}catch(r){O.h(o,"registration_failed_uncaught_exception"),console.error(r)}},W=e=>async(t,s,i)=>{try{const s=await navigator.serviceWorker.register("/sw.js"),i=await s.pushManager.getSubscription();i&&(i.unsubscribe(),Object(l.c)(),e&&t(Object(f.e)({kind:_.b.SuccessCommunity,text:Object(h.c)("Changes saved")})))}catch(n){}}},"./src/reddit/helpers/trackers/notifications.ts":function(e,t,s){"use strict";s.d(t,"g",(function(){return c})),s.d(t,"c",(function(){return u})),s.d(t,"d",(function(){return d})),s.d(t,"e",(function(){return l})),s.d(t,"i",(function(){return b})),s.d(t,"j",(function(){return f})),s.d(t,"h",(function(){return m})),s.d(t,"b",(function(){return p})),s.d(t,"a",(function(){return k})),s.d(t,"f",(function(){return q}));var i=s("./src/reddit/models/PushNotification/index.ts"),n=s("./src/reddit/selectors/telemetry.ts"),o=s("./src/telemetry/index.ts");const r=e=>Object.assign({},n.defaults(e),{noun:"desktop_notification_permissions"}),a=e=>e?"enable":"disable",c=e=>{Object(o.a)(Object.assign({},r(e),{action:"view",source:"popup"}))},u=e=>{Object(o.a)(Object.assign({},r(e),{action:"allow",source:"popup"}))},d=e=>{Object(o.a)(Object.assign({},r(e),{action:"block",source:"popup"}))},l=e=>{Object(o.a)(Object.assign({},r(e),{action:"close",source:"popup"}))},g=(e,t,s)=>Object.assign({},n.defaults(e),{actionInfo:n.actionInfo(e,{success:t,reason:s}),noun:"push_token"}),b=e=>{Object(o.a)(Object.assign({},g(e,!0),{action:"request",source:"notification"}))},f=e=>{Object(o.a)(Object.assign({},g(e,!0),{action:"register",source:"notification"}))},m=(e,t)=>{Object(o.a)(Object.assign({},g(e,!1,t),{action:"bail",source:"notification"}))},p=e=>Object.assign({},(e=>Object.assign({},n.defaults(e),{noun:"push_notification"}))(e),{notification:n.notification(e,void 0,void 0),action:void 0,source:"notification",correlationId:void 0}),j=e=>(t,s)=>{Object(o.a)(Object.assign({},n.defaults(t),{action:a(s),noun:e,source:"notification"}))},v=j("chat_messages"),O=j("chat_requests"),h=j("comment_replies"),_=j("community_recs"),k=j("desktop_notification_permissions"),w=j("live_event"),S=j("post_replies"),y=j("private_messages"),N=j("trending_posts"),P=j("username_mention"),C=j("upvotes_comment"),x=j("upvotes_post"),q=(e,t,s)=>{switch(t){case i.a.ChatMessages:v(e,s),O(e,s);break;case i.a.CommunityRecommendations:_(e,s);break;case i.a.LiveEvent:w(e,s);break;case i.a.TrendingPosts:N(e,s);break;case i.a.UpvotedComments:C(e,s);break;case i.a.UpvotedPosts:x(e,s);break;case i.a.UnreadMessages:h(e,s),S(e,s),y(e,s),P(e,s)}}},"./src/reddit/models/PushNotification/index.ts":function(e,t,s){"use strict";var i;s.d(t,"a",(function(){return i})),function(e){e.ChatMessages="chatMessages",e.CommunityRecommendations="communityRecommendations",e.LiveEvent="liveEvent",e.TrendingPosts="trendingPosts",e.UnreadMessages="unreadMessages",e.UpvotedComments="upvotedComments",e.UpvotedPosts="upvotedPosts"}(i||(i={}))}}]);
//# sourceMappingURL=PushNotifications.4de18eef21272dd432c2.js.map